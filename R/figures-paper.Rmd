---
title: "Figures Paper"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
require(knitr)
opts_knit$set(root.dir = "..")
```


```{r helpers, include=FALSE}
library(tidyverse)
library(ggplot2)
source("R/default-model/helpers-tables.R")
source("R/plot-functions.R")
RESULT_DIR <- "data"

dir.create(file.path(RESULT_DIR, "figs", fsep=.Platform$file.sep), recursive = TRUE, showWarnings = FALSE)
```


```{r params}
params <- tibble(n_tables=500,
                 nor_beta=NA,
                 nor_theta=NA,
                 param_nor_beta=10,
                 param_nor_theta=10,
                 indep_sigma=0.001,
                 bias="none",
                 alpha=3,
                 cost_conditional=0,
                 seed=1234)
```


## Data
# Plot distributions for each table entry for independent cn and one dependent

```{r, tables}
table_params <- params
table_params$n_tables <- 100000
tables_path <- file.path("data", "default-model", "tables-all.rds",
                         fsep=.Platform$file.sep)

if(!file.exists(tables_path)){
  tables <- create_tables(table_params, tables_path)
} else {
  tables <- readRDS(tables_path) %>% filter_tables(table_params)
  if(nrow(tables)==0){
    tables <- create_tables(table_params, tables_path)
  }
}

tables <- tables %>% unnest_tables() %>%
            filter(cn=="A implies C" | cn=="A || C")
plot_tables(tables)
```


## Default model: no bias

Causal nets


```{r}
fn_no_bias <- file.path(RESULT_DIR, "default-model", "results-none.rds")
data_no_bias <- read_rds(fn_no_bias)
```


```{r epistemic-speaker-uncertainty-data}
data_wide <- data_no_bias %>% spread(key=cell, val=val)# %>% adapt_bn_ids()
data_long <- data_wide %>% gather(`AC`, `AC`, `A-C`, `-AC`, `-A-C`, key=cell, val=val)
pc <- marginalize(data_long, c("C")) 
pa <- marginalize(data_long, c("A"))

evs_all <- bind_rows(pc %>% expected_val("C"), pa %>% expected_val("A")) %>% add_column(bias="none")
evs_all
```

```{r epistemic-speaker-uncertainty, message=FALSE}
# plot_marginal_prob(pa, c("A"), evs=evs_all %>% filter(p=="A"), save_as=file.path(RESULT_DIR, "figs", "no-bias-pa.png"))
p <- plot_marginal_prob(pc, c("C"), evs=evs_all %>% filter(p=="C"), save_as=file.path(RESULT_DIR, "figs", "no-bias-pc.png"))
p <- plot_marginal_prob(data_wide, "cns", save_as=file.path(RESULT_DIR, "figs", "no-bias-cns.png"))
p
```


## Biscuit conditionals
read data
```{r}
fn_biscuits <- file.path(RESULT_DIR, "default-model", "results-pizza.rds")
data_biscuit <- read_rds(fn_biscuits)
```


```{r biscuit-conditionals-data}
data_wide <- data_biscuit %>% spread(key=cell, val=val)
pc <- marginalize(data_biscuit, c("C"))
pa <- marginalize(data_biscuit, c("A"))
evs <- bind_rows(expected_val(pc, c("C")), expected_val(pa, c("A"))) %>% add_column(bias="biscuits")
evs
```


```{r biscuit-conditionals, message=FALSE}
plot_marginal_prob(pc, c("C"), evs=filter(evs, p=="C"), save_as=file.path(RESULT_DIR, "figs", "biscuit-pc.png"))
```


## Conditional Perfection data

```{r}
fn_cp <- file.path(RESULT_DIR, "default-model", "results-lawn.rds")
data_cp <- read_rds(fn_cp)
```


```{r conditional-perfection-data}
data_wide <- data_cp %>% spread(key=cell, val=val)
pc <- marginalize(data_cp, c("C")) 
pa <- marginalize(data_cp, c("A")) 
evs <- bind_rows(expected_val(pc, "C"), expected_val(pa, "A")) %>% add_column(bias="cp")
evs
```


```{r conditional-perfection, message=FALSE}
# plot_marginal_prob(pa, c("A"), evs=expected_val(pa, "A"), save_as=file.path(RESULT_DIR, "figs", "cp-pa.png"))
# plot_marginal_prob(pc, c("C"), evs=expected_val(pc, "C"), save_as=file.path(RESULT_DIR, "figs", "cp-pc.png"))

plot_marginal_prob(data_wide, "cns", save_as=file.path(RESULT_DIR, "figs", "cp-cns.png"))
```


```{r evs-pc, message=FALSE}
# plot_evs(evs, marginal="C", save_as=file.path(RESULT_DIR, "figs", "evs-pc.png"))
# plot_evs(evs, marginal="A", save_as=file.path(RESULT_DIR, "figs", "evs-pa.png"))
```


```{r}
# voi_none_all <- readRDS(file.path("data", "default-model", "results-none-voi-sweep.rds"))
voi_none_all <- readRDS("data/default-model/results-none-voi.rds")
```

## Value-of-interest for epistemic uncertainty (no bias)

```{r}
voi_none <- voi_none_all %>% filter(key=="epistemic_uncertainty") %>% filter_tables(params) %>%
              filter_by_model_params(params)

p <- voi_none %>% 
      mutate(value=round(as.numeric(value), 3)) %>% 
        ggplot() + 
          geom_bar(mapping = aes(x=level, y=value, fill=level),
                   stat="identity")  +
          scale_x_discrete(limits = c("prior", "LL", "PL")) +
          labs(y="P(C)<0.1 + P(C)>0.9") + 
          theme(axis.text.x = element_text(angle = 45, hjust = 1),
                text = element_text(size= 20),
                legend.position = "bottom", legend.title = element_blank(), legend.direction = "horizontal")

ggsave(paste(RESULT_DIR, "figs", "epistemic-uncertainty-none.png", sep=.Platform$file.sep), p)
p
```


# Value-of-interest for biscuit bias

```{r}
# voi_pizza_all <- readRDS(file.path("data", "default-model", "results-pizza-voi-sweep.rds"))
voi_pizza_all <- readRDS("data/default-model/results-pizza-voi.rds")
```


```{r}
params_biscuits <- params
params_biscuits$bias <- "pizza"
params_biscuits$n_tables <- 500*9
voi_pizza <- voi_pizza_all %>% filter(key=="pc") %>% filter_tables(params_biscuits) %>%
              filter_by_model_params(params_biscuits)

p <- voi_pizza %>% 
      mutate(value=round(as.numeric(value), 3)) %>% 
        ggplot() + 
          geom_bar(mapping = aes(x=level, y=value, fill=level),
                   stat="identity")  +
          scale_x_discrete(limits = c("prior", "LL", "PL")) +
          labs(y=TeX('$\\mathbf{E}(P(C))$')) +
          theme(axis.text.x = element_text(angle = 45, hjust = 1),
                text = element_text(size= 20),
                legend.position = "bottom", legend.title = element_blank(), legend.direction = "horizontal")

ggsave(paste(RESULT_DIR, "figs", "ev-pc-pizza.png", sep=.Platform$file.sep), p)
p
```


# CP-strengths for lawn-bias and no-bias 

Strength measured by **cp-bns**:

expected value of hellinger distance between the joint probability distribution of each Bayes net and
P(A,C)=0.5, P(-A,-C)=0.5 or P(A,-C)=0.5, P(-A,C)=0.5
weighted by prior probability of respective Bayes net.


Strength measured by **cp-cns**:

Hellinger distance between marginal probability over causal nets and P(A->C)=0.25, P(-A->-C)=0.25, P(C->A)=0.25, P(-C->-A)=0.25


```{r}
# voi_lawn_all <- readRDS(file.path("data", "default-model", "results-lawn-voi-sweep.rds"))
voi_lawn_all <- readRDS("data/default-model/results-lawn-voi.rds")
voi_none_all <- readRDS("data/default-model/results-none-voi.rds")

params_cp <- params
params_cp$bias <- "lawn"
```

```{r}
filter_vois_cp <- function(data, params){
  # data %>% filter(startsWith(key, "cp_bns") | startsWith(key, "cp_cns") | key=="p_nc_given_na") %>% 
  # data %>% filter(key=="cp_bns_ac" | key=="cp_cns_ac" | key=="p_nc_given_na") %>% 
   data %>% filter(key=="cp_bns_ac" | key=="cp_cns_ac" | key=="p_nc_given_na") %>% 
                  filter_tables(params) %>%
                  filter_by_model_params(params) %>% dplyr::select(level, value, key, bias)
}

voi_lawn_none <- filter_vois_cp(voi_none_all, params)

params_cp <- params %>% mutate(bias="lawn")
voi_lawn_cp <- filter_vois_cp(voi_lawn_all, params_cp)

data <- bind_rows(voi_lawn_none, voi_lawn_cp)
data <- data %>% mutate(order=case_when(level=="prior" ~ "a",
                                        level=="LL" ~ "b",
                                        TRUE ~ "c"))
# plot only values for bias=none
p <- plot_cp_vois(data %>% filter(bias=="none"))
ggsave(paste(RESULT_DIR, "figs", "vois-cp_bias_none.png", sep=.Platform$file.sep), p)
p

# plot only values for bias=lawn
p <- plot_cp_vois(data %>% filter(bias=="lawn"))
ggsave(paste(RESULT_DIR, "figs", "vois-cp_bias_lawn.png", sep=.Platform$file.sep), p)
p

# plot comparison between cp-strengths for bias-none and bias-lawn
p <- plot_cp_vois(data)
ggsave(paste(RESULT_DIR, "figs", "vois-cp_comparison.png", sep=.Platform$file.sep), p)
p
```


## Values of interest depending on combination of alpha and cost

<!-- ```{r param-sweep, message=FALSE} -->
<!-- data <- data %>% filter(seed==1234) -->
<!-- plot_voi_alpha_cost(data, 1, "epistemic_uncertainty", "PL") -->

<!-- plot_voi_alpha_cost(data, 2, "biscuits_pc", "LL") -->
<!-- plot_voi_alpha_cost(data, 2, "biscuits_pc", "PL") -->

<!-- df <- data %>% filter(key=="cp-cns" | key=="cp-bns") %>% -->
<!--         filter(model_id == 1 | model_id == 3) %>% -->
<!--         separate(value, c("dir", "value"), sep="_") -->

<!-- # value of interest considering causal nets -->
<!-- plot_voi_alpha_cost(df, 1, "cp-cns", "LL") -->
<!-- plot_voi_alpha_cost(df, 1, "cp-cns", "PL") -->

<!-- plot_voi_alpha_cost(df, 3, "cp-cns", "LL") -->
<!-- plot_voi_alpha_cost(df, 3, "cp-cns", "PL") -->

<!-- # value of interest considering bayes nets -->
<!-- plot_voi_alpha_cost(df, 1, "cp-bns", "LL") -->
<!-- plot_voi_alpha_cost(df, 1, "cp-bns", "PL") -->

<!-- plot_voi_alpha_cost(df, 3, "cp-bns", "LL") -->
<!-- plot_voi_alpha_cost(df, 3, "cp-bns", "PL") -->

<!-- ``` -->


<!-- ## Douven examples -->
<!-- 1. Sundowners -->
<!-- ```{r sundowners, message=FALSE} -->
<!-- fn <- file.path(RESULT_DIR, "sundowners.rds") -->
<!-- data <- readRDS(fn) -->
<!-- data_wide <- data %>% spread(key=cell, val=val, fill = 0) -->

<!-- pr <- marginalize(data, c("R")) -->
<!-- plot_marginal_bar(pr, "R", save_as=file.path(RESULT_DIR, "figs", "sundowners-pr.png")) -->
<!-- ``` -->

<!-- 1.1 Literal Listener distributions for each utterance -->

<!-- ```{r, message=FALSE} -->
<!-- fn <- file.path(RESULT_DIR, "model-5-LL-all-utts.rds") -->
<!-- data <- readRDS(fn) -->


<!-- data_wide <- data %>% group_by(u, rowid) %>% spread(key=cell, val=val, fill=0) -->
<!-- bns <- data_wide %>% group_by(cn, RS, `-RS`, `-RS-W`, `R-SW`) %>% mutate(bn_id=group_indices()) -->


<!-- for(u in bns$u %>% unique()){ -->
<!--   df <- bns %>% filter(u== (!! u)) %>% rename(p=bn_id) %>% add_column(level="LL") -->
<!--   p <- plot_marginal_bar(df, "bns", title=u, save_as=NULL) -->
<!--   print(p) -->
<!-- } -->

<!-- ``` -->






