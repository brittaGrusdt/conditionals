---
title: "Model sundowners and skiing example"
author: "Britta Grusdt"
date: "5/6/2019"
output: html_document
---

```{r}
knitr::opts_chunk$set(warning=FALSE, message=FALSE)
```

```{r helpers, echo = FALSE}
library(tidyverse)
library(ggplot2)
```


```{r, echo=FALSE}
# HELPERS
rds_to_tibbles <- function(data){
  data_tibbles <- data %>%
  map(function(x){
    x %>% transmute(cn=support$cn,
                    table_x=support$table.support,
                    table_probs=support$table.probs,
                    bn_probs=probs) %>% 
    rowid_to_column("bn_id") %>% 
      mutate("bn_id" = as.character(bn_id))
  })
}

marginalize <- function(data, vars){
  for(var in vars){
    if(var %>% startsWith("-")) {
      data <- data %>% filter(stringr::str_detect(table_x, var)) 
    } else {
      var_neg <- paste("-", var, sep="")
      data <- data %>% filter(!stringr::str_detect(table_x, var_neg))
    }  
  } 
  return(data)
}

marginals <- function(df, vars){
  seq(nrow(df)) %>% 
    map(function(i){
      tibble(table_x = df$table_x[[i]], table_probs=df$table_probs[[i]]) %>% 
      marginalize(vars) %>% 
      summarise(marginal=sum(table_probs)) %>% 
        mutate(probs=df$bn_probs[i])
    }) %>% bind_rows()
}


plot_bns <- function(data, distribution_str){
    ggplot(data = data) + 
    geom_bar(mapping = aes(x=bn_id, y=bn_probs), stat="identity") +
    labs(title = distribution_str)
}

plot_cns <- function(data, distribution_str){
  # Causal Nets
  ggplot(data = data) + 
    geom_bar(mapping = aes(x=cn, y=bn_probs), stat="identity") + 
    labs(title = distribution_str, y="probability")
}

plot_bn_table <- function(data, id, distribution_str){
  df <- data %>%  filter(bn_id==id)
  x <- df$table_x[[1]]
  y <- df$table_probs[[1]]
  p <- df$bn_probs
  ggplot(data=tibble(x=x, probs=y)) + 
    geom_bar(mapping = aes(x=x, y=probs), stat="identity") +
    labs(title = paste(distribution_str, ": P(bn", id, "): ", p, " cn: ", df$cn, sep=""),
         y="probability")
}

plot_marginal <- function(data, vars, distribution_str){
  df <- data %>%  select(table_x, table_probs, bn_probs)
  df_marginal <- df %>% marginals(vars) %>% mutate(marginal=as.character(marginal))
  
  vars_str <- paste(vars, collapse = "")
  ggplot(data = df_marginal) +
  geom_bar(mapping = aes(x=marginal, y=probs), stat="identity") +
  labs(x = paste('P(', vars_str, ')'),
       y = "probability",
       title = distribution_str)
}
```

# Get Data

```{r}
skiing <- read_rds("../data/skiing.rds") %>% rds_to_tibbles()
sundowners <- read_rds("../data/sundowners.rds") %>%  rds_to_tibbles()
```

# Skiing example
## Prior

```{r}
distr <- "prior"
skiing[[distr]] %>% plot_cns(distr)
skiing[[distr]] %>% plot_bns(distr)
skiing[[distr]] %>% plot_bn_table(1, distr)

skiing[[distr]] %>% plot_marginal(c("E"), distr)
```

## Literal Listener

```{r}
distr <- "LL"
# skiing[[distr]] %>% plot_cns(distr)
skiing[[distr]] %>% plot_bns(distr)
skiing[[distr]] %>% plot_bn_table(1, distr)

skiing[[distr]] %>% plot_marginal(c("E"), distr)
```

## Pragmatic Listener
The listener has evidence for variable *C* (buying clothes); i.e. the
distribution of the single bayes net that receives non-zero probability after
hearing *If she passes the exam, her father takes her on a skiing trip* (E > S),
is conditioned on *C=TRUE*.

```{r}
distr <- "PL"
# skiing[[distr]] %>% plot_cns(distr)
# skiing[[distr]] %>% plot_bns(distr)
skiing[[distr]] %>% plot_bn_table(1, distr)

skiing[[distr]] %>% plot_marginal(c("E"), distr)

```


# Sundowners example

## Prior

```{r}
distr <- "prior"
sundowners[[distr]] %>% plot_cns(distr)
sundowners[[distr]] %>% plot_bns(distr)

sundowners[[distr]] %>% plot_bn_table(1, distr)
sundowners[[distr]] %>% plot_bn_table(4, distr)

sundowners[[distr]] %>% plot_marginal(c("R"), distr)

```

## Literal Listener

```{r}
distr <- "LL"
# sundowners[[distr]] %>% plot_cns(distr)
sundowners[[distr]] %>% plot_bns(distr)
sundowners[[distr]] %>% plot_bn_table(1, distr)

sundowners[[distr]] %>% plot_marginal(c("R"), distr)

```

## Pragmatic Listener

```{r}
distr <- "PL"
# sundowners[[distr]] %>% plot_cns(distr)
sundowners[[distr]] %>% plot_bns(distr)
sundowners[[distr]] %>% plot_bn_table(2, distr)

sundowners[[distr]] %>% plot_marginal(c("R"), distr)


```


